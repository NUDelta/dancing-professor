
<html>
<head>
    <title>MOOC Video Labeling</title>
    <style type="text/css">
    </style>
</head>
<body>

    <div>
        <div class="section">
            <div id="ytplayer">You need Flash player 8+ and JavaScript enabled to view this video.</div>
        </div>

        <div class="section">
            <form id="submitForm" action="https://www.mturk.com/mturk/externalSubmit" method="POST">
            <input type="hidden" name="assignmentId" id="assignmentId" value="">
                <input type="hidden" name="pausedTimes" id="pausedTimes" value="">
                <input type="hidden" name="pausedTimestamps" id="pausedTimestamps" value="">
                <input type="hidden" name="resumedTimestamps" id="resumedTimestamps" value="">
            </form>
        </div>
    </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
    <!-- <script src="player.js"></script> -->

    <script type="text/javascript">
        // Parse URL Parameters
        var prmstr = window.location.search.substr(1);
        var prmarr = prmstr.split("&");
        var params = {};
        for ( var i = 0; i < prmarr.length; i++) {
            var tmparr = prmarr[i].split("=");
            params[tmparr[0]] = tmparr[1];
        }

        var id = params["id"];
        var isPreview = false;
        if (typeof params["assignmentId"] === "undefined" || params["assignmentId"] == "ASSIGNMENT_ID_NOT_AVAILABLE")
            isPreview = true;
        if (typeof params["preview"] !== "undefined" && params["preview"] == 0)
            isPreview = false;

        var workerId = "";
        if (typeof params["workerId"] !== "undefined")
            workerId = params["workerId"];

        var vid = "2NIG1bt8aPU"; // default video ID
        if (params["id"]) {
            vid = params["id"]
        }

        var vidParams = { allowScriptAccess: "always", allowFullScreen: "false" };
        var atts = { id: "ytplayer" };
        swfobject.embedSWF("https://www.youtube.com/v/" + vid + "?enablejsapi=1&playerapiid=ytplayer&version=3&controls=0&rel=0&origin=https://people.csail.mit.edu", "ytplayer", "640", "360", "8", null, null, vidParams, atts);

        var player;
        var position = 0;
        var timestamps = [{"start": 154, "end": 290}];

        function Timer(delay) {
            var timerId, start, remaining = delay;
            var paused = true;

            var c = function() {$('#submitBtn').removeAttr('disabled').removeClass('disabled')};

            this.pause = function() {
                if (!paused) {
                    paused = true;
                    window.clearTimeout(timerId);
                    remaining -= new Date() - start;
                }
            };

            this.resume = function() {
                if (paused) {
                    paused = false;
                    start = new Date();
                    // console.log(remaining);
                    timerId = window.setTimeout(c, remaining);
                }
            };

            this.resume();
        }

        function isInt(n) {
           return typeof n === 'number' && n % 1 == 0;
        }

        function formatTime(stringTime){
            var data = stringTime.split(":");
            var sec = parseInt(data[0])*60 + parseInt(data[1]);
            return sec;
        }

        function toMMSS(input) {
            var sec_num = parseInt(input, 10); // don't forget the second param
            var hours   = Math.floor(sec_num / 3600);
            var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            var seconds = sec_num - (hours * 3600) - (minutes * 60);

            if (minutes < 10) {minutes = "0"+minutes;}
            if (seconds < 10) {seconds = "0"+seconds;}
            var time    = minutes+':'+seconds;
            return time;
        }

        function onYouTubePlayerReady(playerId) {
            console.log("onPlayerReady");
            player = document.getElementById("ytplayer");
            player.addEventListener("onStateChange", "onPlayerStateChange");
            setInterval(updatePlayerInfo, 600);
            updatePlayerInfo();
        }


        //    The API calls this function when the player's state changes.
        //    The function indicates that when playing a video (state=1),
        //    the player should play for six seconds and then stop.

        function onPlayerStateChange(state) {
            console.log("CHANGE", state);
            if (state == -1){

            } else if (state == 1) {
                // $(".duration").text(toMMSS(player.getDuration()));
                console.log("playing", player.getCurrentTime());

                if (!timer) {
                    timer = new Timer(Math.floor(player.getDuration() * 900));
                } else {
                    timer.resume();
                }
            } else if (state == 2) {
                console.log("paused", player.getCurrentTime());
                timer.pause();
            } else if (state == 0){
                // ended
                timer.pause();
                // $("#submitBtn").removeClass('disabled').removeAttr('disabled');
            }
        }


        function updatePlayerInfo(){
            // $(".curTime").text(toMMSS(player.getCurrentTime()));
            for (var i in timestamps) {
                var peak = timestamps[i];
                // only trigger the first time (video not paused)
                if (player.getPlayerState() != 2 && parseInt(player.getCurrentTime()) == parseInt(peak["end"])) {
                        console.log("End of a peak, prompt!");
                }
            }
        }


        $(document).ready(function() {
        });
    </script>
</body>

</html>
